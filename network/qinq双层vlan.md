# **一、QinQ（802.1Q-in-Q）：双层VLAN的核心实现**

QinQ（802.1Q-in-802.1Q）是一种**二层VLAN扩展技术**，通过在数据帧中叠加两层802.1Q标签，解决传统单层VLAN（4094个）资源不足的问题。

**1. QinQ的帧结构与封装细节**

传统802.1Q帧的结构为：

```bash
以太网头部（14字节） +  802.1Q标签（4字节） +  数据载荷
```

QinQ在传统802.1Q标签**之外再叠加一层标签**，形成双层结构：

```bash
以太网头部（14字节） +  外层802.1Q标签（S-VLAN，4字节） +  内层802.1Q标签（C-VLAN，4字节） +  数据载荷
```

每个802.1Q标签包含：

* TPID（Tag Protocol Identifier，2字节）：标识标签类型，标准值为 0x8100（表示802.1Q标签）；
* TCI（Tag Control Information，2字节）：包含VLAN ID（12位）、优先级（3位）、DEI（1位，丢弃指示位）。

**2. QinQ的分类与应用场景**

根据外层标签（S-VLAN）的分配方式，QinQ可分为以下类型：

| **类型**                            | **定义**                                                         | **典型场景**                                                                |
| ----------------------------------------- | ---------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| **基本QinQ（Static QinQ）**         | 外层S-VLAN与物理端口绑定（静态配置），同一端口所有流量使用相同S-VLAN。 | 运营商宽带接入（如小区用户通过同一OLT端口接入，S-VLAN区分小区，C-VLAN区分用户）。 |
| **灵活QinQ（Selective QinQ）**      | 外层S-VLAN根据内层C-VLAN动态分配（需配置映射表）。                     | 企业多分支VPN（不同分支使用不同C-VLAN，通过S-VLAN映射到同一企业VPN）。            |
| **基于流的QinQ（Flow-based QinQ）** | 外层S-VLAN根据流量特征（如源 IP、协议类型）动态分配。                  | 多业务融合网络（如区分语音、视频、数据流量，分别映射不同 S-VLAN优先级）。         |
| **QinQ穿透（QinQ Transparent）**    | 运营商网络完全保留用户C-VLAN，仅通过S-VLAN转发，不修改内层标签。       | 企业自管理VLAN场景（运营商不感知用户侧VLAN规划）。                                |

**3. QinQ的封装与解封装流程**

以运营商宽带接入为例，完整流程如下：

1. **用户侧（CPE）** ：
   - 用户终端（如PC）发送携带C-VLAN（如C=100）的帧
   - 或未打标签，由接入设备通过PVID添加C-VLAN
2. **接入设备（如OLT）** ：
   * 接收用户帧，检查是否有C-VLAN标签（无标签则根据PVID添加C-VLAN）
   * 添加外层S-VLAN（如S=2000），形成双层标签帧（S=2000，C=100）
3. **骨干网传输** ：
   - 运营商核心设备仅根据外层S-VLAN（2000）转发，不处理内层 C-VLAN（100）
4. **汇聚设备（如BRAS）** ：
   * 收到双层标签帧后，剥离外层 S-VLAN（2000），保留内层C-VLAN（100）
   * 将仅含C-VLAN（100）的帧转发至目标用户或上层业务平台（如IP城域网）

# **二、S-VLAN与C-VLAN：双层标签的分工**

S-VLAN（Service Provider VLAN）和C-VLAN（Customer VLAN）是QinQ的核心组成部分，分别对应外层和内层标签，承担不同的网络角色。

**1. S-VLAN（运营商VLAN）**

* **角色** ：运营商网络的"逻辑通道标识"，用于骨干网的流量转发、隔离和QoS控制。
* **特点** ：
  * 由运营商设备（如OLT、BRAS）添加，仅在运营商网络内部有效
  * 取值范围通常为1-4094（与C-VLAN独立），但需避免与公共网络VLAN冲突
  * 可关联QoS策略（如优先级、带宽限制），例如S-VLAN=2000的流量优先级设为4（语音业务）

**2. C-VLAN（用户VLAN）**

* **角色** ：用户侧的"业务细分标识"，用于用户内部的流量隔离（如部门、业务类型）。
* **特点** ：
  * 由用户设备（如企业交换机）或接入设备（通过PVID）添加
  * 运营商网络不修改C-VLAN（仅穿透或保留），仅在用户侧或边缘设备处理
  * 典型场景：企业总部与分支通过C-VLAN=101（财务）、102（研发）隔离不同部门流量

# **三、TPID（Tag Protocol Identifier）：标签的"身份证"**

TPID是802.1Q标签中的2字节字段，用于标识数据帧是否携带VLAN标签及标签类型。分以下两种：

**标准TPID（0x8100）**：表示符合IEEE 802.1Q标准的VLAN标签，所有支持802.1Q的设备均识别此值。

**扩展TPID（如0x9100、0x88A8）**：

* 0x9100：部分厂商（如早期H3C）的私有VLAN标签标识；
* 0x88A8：IEEE 802.1ah（Provider Backbone Bridges，PBB）标准的标签，用于运营商骨干网的MAC-in-MAC封装。

TPID的主要作用：

**标签识别**：交换机通过TPID判断帧是否携带VLAN标签。例如，收到TPID=0x8100的帧，交换机知道需解析后续的TCI字段。

**兼容性处理**：当网络中存在混合设备（如旧交换机仅支持0x9100），需在边界设备配置TPID转换（如将0x9100转换0x8100）。
