# 函数原型

```c
int brk (void *addr);

void *sbrk (intptr_t delta);
```

# 函数功能

brk系统调用，将堆段的brk指针设置为addr。brk系统调用常用于内存的释放。成功时返回0，错误时返回-1并设置errno变量。

sbrk系统调用常用于内存的申请与释放，如果成功，返回上一个数据空间结束的地址（即下一个空间的开始地址）; 如果失败，返回-1并设置errno变量。sbrk系统调用，会将堆段增加或减少delta字节:

- delta < 0时，释放delta字节的内存
- delta = 0时，返回brk指针的位置
- delta > 0时，申请delta字节的内存

glibc的malloc和free函数封装了brk和sbrk系统调用，用于内存的申请和释放，下图是进程的内存分布图（每个进程都认为自己占据了除内核空间外的所有内存）：

```bash
<----->   +---------------------------+
  1GB     |        Kernel Space       |  # 内核空间，用户代码不能读写，否则导致段错误
<----->   +---------------------------+
          |                           |  # 随机偏移
          +---------------------------+
          |           Stack           |
          |             |             |
          |             v             |
          +---------------------------+
          |                           |  # 随机偏移
          +---------------------------+
          |   Memory Mapping Segment  |  # 文件映射段，比如 /lib/libc.so 会映射在此
          |             |             |
          |             v             |
          +---------------------------+
  3GB     |                           |  # 随机偏移
          +---------------------------+  -> brk
          |             ^             |
          |             |             |
          |           Heap            |
          +---------------------------+  -> brk_start
          |                           |  # 随机偏移
          +---------------------------+
          |           Bss             |  # 未初始化的静态变量，填充 0
          +---------------------------+
          |           Data            |  # 已初始化的静态变量
          +---------------------------+
          |           Text            |  # 二进制代码段，比如 elf/img/bin 文件
          +---------------------------+  -> 0x00040000
          |                           |
<----->   +---------------------------+  -> 0
```

# 使用举例

```c
#include <stdint.h>
#include <stdio.h>
#include <unistd.h>

int main(int argc, char *argv[])
{
	void *tmp = NULL;

	// 记录 brk 的开始位置
	printf("brk: 0x%08lx\n", (uintptr_t)sbrk(0));

	// 申请4字节内存，等价于 brk(x + 4)
	sbrk(4);
	printf("brk: 0x%08lx\n", (uintptr_t)sbrk(0));

	// 释放内存，等价于 brk(x - 4)
	sbrk(-4);
	printf("brk: 0x%08lx\n", (uintptr_t)sbrk(0));
	return 0;
}
```

运行结果如下：

```bash
# gcc -o out out.c && ./out 
brk: 0x55b1e1732000
brk: 0x55b1e1753004
brk: 0x55b1e1753000
```
